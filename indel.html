<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã¿ã‚“ãªã®è¾æ›¸ï¼ˆ2chãƒˆãƒªãƒƒãƒ—å¼ï¼‰</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .entry { border-bottom: 1px solid #ccc; margin-bottom: 1em; padding-bottom: 1em; }
    .trip { color: #888; font-size: 0.9em; }
    .like { color: #e44; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ã¿ã‚“ãªã®è¾æ›¸ï¼ˆ2chãƒˆãƒªãƒƒãƒ—å¼ï¼‰</h1>
  <form id="postForm">
    <input type="text" id="word" placeholder="å˜èªï¼ˆä¾‹: èµ¤ç©‚æµªå£«ï¼‰" required>
    <input type="text" id="name" placeholder="åå‰#ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
    <br>
    <textarea id="meaning" placeholder="æ„å‘³ãƒ»èª¬æ˜" required rows="3" cols="40"></textarea>
    <br>
    <button type="submit">æŠ•ç¨¿</button>
  </form>
  <hr>
  <div id="entries"></div>

  <script>
    // ç°¡æ˜“ãƒˆãƒªãƒƒãƒ—ç”Ÿæˆï¼ˆ2chæ–¹å¼ã®ç°¡æ˜“ç‰ˆ: cryptã®ä»£ã‚ã‚Šã«SHA-1ã‚’åˆ©ç”¨ï¼‰
    async function makeTrip(key) {
      if (!key) return '';
      const encoder = new TextEncoder();
      const data = encoder.encode(key);
      const hashBuffer = await crypto.subtle.digest('SHA-1', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return 'â—†' + hashHex.slice(0, 10);
    }

    // æŠ•ç¨¿ä¿å­˜ãƒ»å–å¾—ï¼ˆlocalStorageåˆ©ç”¨ï¼‰
    function getEntries() {
      return JSON.parse(localStorage.getItem('entries') || '[]');
    }
    function saveEntries(entries) {
      localStorage.setItem('entries', JSON.stringify(entries));
    }

    // æŠ•ç¨¿è¡¨ç¤º
    async function renderEntries() {
      const entries = getEntries();
      const container = document.getElementById('entries');
      container.innerHTML = '';
      for (const [i, entry] of entries.entries()) {
        const trip = entry.trip ? `<span class="trip">${entry.trip}</span>` : '';
        container.innerHTML += `
          <div class="entry">
            <b>${entry.word}</b> ${trip}<br>
            <div>${entry.meaning.replace(/\n/g, '<br>')}</div>
            <div>
              <span class="like" data-idx="${i}">ğŸ‘ ${entry.likes || 0}</span>
              <span style="color:#aaa; font-size:0.8em;">${new Date(entry.date).toLocaleString()}</span>
            </div>
          </div>
        `;
      }
      // ã„ã„ã­ãƒœã‚¿ãƒ³
      document.querySelectorAll('.like').forEach(el => {
        el.onclick = function() {
          const idx = +el.dataset.idx;
          const liked = JSON.parse(localStorage.getItem('liked') || '[]');
          if (liked.includes(idx)) return alert('ã™ã§ã«ã„ã„ã­æ¸ˆã¿ã§ã™');
          entries[idx].likes = (entries[idx].likes || 0) + 1;
          liked.push(idx);
          localStorage.setItem('liked', JSON.stringify(liked));
          saveEntries(entries);
          renderEntries();
        };
      });
    }

    // æŠ•ç¨¿å‡¦ç†
    document.getElementById('postForm').onsubmit = async function(e) {
      e.preventDefault();
      const word = document.getElementById('word').value.trim();
      const nameInput = document.getElementById('name').value.trim();
      const meaning = document.getElementById('meaning').value.trim();
      let trip = '';
      let name = '';
      if (nameInput.includes('#')) {
        [name, tripKey] = nameInput.split('#', 2);
        trip = await makeTrip(tripKey);
      } else {
        name = nameInput;
      }
      const entries = getEntries();
      entries.unshift({
        word, meaning, name, trip,
        date: new Date().toISOString(),
        likes: 0
      });
      saveEntries(entries);
      document.getElementById('postForm').reset();
      renderEntries();
    };

    // åˆæœŸè¡¨ç¤º
    renderEntries();
  </script>
</body>
</html>
